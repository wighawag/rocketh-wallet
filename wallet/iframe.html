<!DOCTYPE html>
<html>
	<head>
		<title>Hidden Iframe</title>
	</head>
	<body>
		<a id='authorizationLink' href="popup.html#type=transaction&id=1" target="_blank">Auhtorization Requested!</a>
	
		<!-- This exposes the library as a global variable: ethers // TODO inject the whole js into the page -->
		<script src="ethers-v4.min.js" 
		charset="utf-8"
		type="text/javascript">
		</script>
		
		<script>
		var authorizationLink = document.getElementById('authorizationLink');

		// TODO do not leave unecnryoted, except for sessionStorage to provide an better UX // TODO no as this might be save to disk too?
		var privateKey = sessionStorage.getItem('_priv');
		var enabled = false;
		var accountPresent = false;
		if(!privateKey) {
			privateKey = localStorage.getItem('_priv'); // TODO use encrypted data for localstorage // TODO would need a popup to decrypt
			if(privateKey) {
				sessionStorage.setItem('_priv', privateKey);
			}
		} else {
			console.log('session storage');
		}
		
		var wallet
		if(privateKey)  {
			accountPresent = true;
			wallet = new ethers.Wallet(privateKey);
		} else {
			accountPresent = false;
		}

		var supportedMethods = {
			"eth_accounts": function (payload, callback) {
				callback(null, [wallet.address]);
			},
			"eth_signTransaction": function (payload, callback, confirmed) {
				if(!confirmed) {
					callback(null, null, 'transaction');
				} else {
					if(confirmed == 'yes') {
						wallet.sign(payload.params[0])
							.then(function(result){
								callback(null, result);
							})
							.catch(function(error){
								callback(error);
							});
					} else {
						callback({message:"refused by user",type:"refused"});
					}
				}
			},

			"eth_signMessage": function(payload, callback, popupAnswer) {
				if(payload.params[0].toLowerCase() !== wallet.address.toLowerCase()) {
					callback('cannot sign for ' + payload.params[0]);
					return;	
				}
				if(!popupAnswer) {
					callback(null, null, 'transaction');
				} else {
					if(popupAnswer == 'yes') {
						wallet.signMessage(payload.params[0])
							.then(function(result){
								callback(null, result);
							})
							.catch(function(error){
								callback(error);
							});
					} else {
						callback({message:"refused by user",type:"refused"});
					}
				}
			},

			"enable": function(payload, callback, popupAnswer) { // TODO move out of here
				if(!popupAnswer) {
					callback(null, null, accountPresent? 'enable' : 'new_account');
				} else {
					if(popupAnswer == 'yes') {
						enabled = true;
						callback(null);
					} else {
						callback('refused');
					}
				}
			},

			// "new_account": function(payload, callback, complete) { // TODO move out of here
			// 	if(!complete) {
			// 		callback('cannot create account without popup process'); // TODO ?
			// 	} else {
			// 		// TODO if(complete == 'yes'){}
			// 		accountPresent = true; // TODO decrypt via password provided
			// 		enabled = true;
			// 		// TODO popup ui to ask give the seed and ask password for encryption
			// 		// + start to generate a unique pattern to protect use from malicious attempt at capturing its password
			// 		wallet = ethers.Wallet.createRandom();
			// 		privateKey = wallet.privateKey;
			// 		localStorage.setItem('_priv', privateKey);
			// 		sessionStorage.setItem('_priv', privateKey);
			// 		source.postMessage("enabled","*"); //TODO do not use wildcard 
			// 	}
			// },
		};

		var firstOrigin = null;
		var source = window.parent;
		var currentUserConfirmation = null;
		
		function receiveMessage(event){
			console.log('IFRAME receiving', event.data);
			if(event.origin == window.origin) {
				console.log('from popup');
				if(event.data.type == 'ready') {
					console.log('popup ready to get data');
					if(currentUserConfirmation) {
						 // should we check it is new ? // or can the popup do it via id specified before
						event.source.postMessage(currentUserConfirmation, event.origin);
					} else {
						console.error('no user confirmation was waiting...');
					}
				} else if(event.data.type == 'confirmation') {
					console.log('POPUP transaction', event.data);
					console.log('WAITING for', currentUserConfirmation);
					if(currentUserConfirmation && currentUserConfirmation.id == event.data.id) {
						var copy = currentUserConfirmation;
						currentUserConfirmation = null;
						if(event.data.result) {
							processMessage(copy, source, event.data.result);
						} else {
							source.postMessage({id:copy.id,result:null,error:event.data.error},firstOrigin);
						}
					} else {
						console.error('old confirmation popup ?');
					}
				}
			}
			if(event.source != source){
				return;
			}
			if(firstOrigin){
				if(firstOrigin != event.origin){
					return;
				}
			}else{
				firstOrigin = event.origin;
			}

			console.log('from trusted host');

			var data = event.data;

			// if(data == "enable") { // TODO move that into processMessage
			// 	if(!accountPresent) {
			// 		currentUserConfirmation = {id: 99999, method:"new_account", params:[]}; // TODO use diffetent object type, as they won;t give anything back to host (html-provider)
			// 		authorizationLink.href = "popup.html#type=" + 'new_account' + "&id=" + currentUserConfirmation.id;
			// 		source.postMessage("no_account","*"); //TODO do not use wildcard
			// 	} else if (!enabled) {
			// 		currentUserConfirmation = {id: 99999, method:"enable", params:[]}; // TODO use diffetent object type, as they won;t give anything back to host (html-provider)
			// 		authorizationLink.href = "popup.html#type=" + 'enable' + "&id=" + currentUserConfirmation.id;
			// 		source.postMessage("not_enabled","*"); //TODO do not use wildcard
			// 	}
			// 	return;
			// }

			if(!accountPresent) {
				event.source.postMessage({id:data.id,result:null,error:{message:"No Account",type:"notValid"}},firstOrigin);
			} else if(!enabled && data.method != 'enable') {
				event.source.postMessage({id:data.id,result:null,error:{message:"Account locked",type:"notValid"}},firstOrigin);
			} else {
				try{
					processMessage(data,event.source);
				}catch(e){
					event.source.postMessage({id:data.id,result:null,error:{message:"Could not process message data",type:"notValid"}},firstOrigin);
					console.error("Error", "The application has sent invalid data", data);
				}
			}
			
			
		}
	
		function processMessage(payload, sourceWindow, popupAnswer){
			console.log('IFRAME, processMessage', payload);
			if(supportedMethods[payload.method]){
				supportedMethods[payload.method](payload, function(error, result, confirmationType) {
					if(confirmationType) {
						console.log('IFRAME confirmationType', confirmationType);
						console.log('payload', payload);
						currentUserConfirmation = payload; // TODO queue system ?
						authorizationLink.href = "popup.html#type=" + confirmationType + "&id=" + payload.id;
					}
					sourceWindow.postMessage({id:payload.id, result:result, error:error, requireUserConfirmation:confirmationType != null}, firstOrigin);
				}, 
				popupAnswer);
			}else{
				sourceWindow.postMessage({id:payload.id, result:null, error:{message:"method (" + payload.method + ") not supported in iframe", type:"notSupported"}},firstOrigin);
			}
		}
		
		window.addEventListener("message", receiveMessage);
		//TODO trigger ready so IfrAmeProvider can release the quued request after that // not the same ready as above (TODO delete or rename it to "enabled")
		</script>
	</body>
</html>