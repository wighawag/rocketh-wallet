<!DOCTYPE html>
<html>
	<head>
		<title>Hidden Iframe</title>
	</head>
	<body>

		<!-- iframe is responsible for listening to popup confirmation-->
		<a id='authorizationLink' href="popup.html#type=transaction&id=1" target="_blank">require authorization</a>

		<!-- does not need to use window.open -->
		<!-- <a id='authorization' href="/" target="_blank">require authorization</a> -->
		<!-- <script>
			var element = document.getElementById('authorization');
			element.onclick = function() {
				var popup = window.open('popup.html', '_blank');
				if(!popup) {
					// TODO show arning to use , unblock popups ?
				}
				console.log('popup', popup);
				// TODO listen for events 
				// upon confirmation -> give back result to iframe listener (HtmlProvider)
			}
		</script> -->


			
		<!-- This exposes the library as a global variable: ethers -->
		<script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"
		charset="utf-8"
		type="text/javascript">
		</script>
		
		<script>
		var authorizationLink = document.getElementById('authorizationLink');

		
		// TODO do not leave unecnryoted
		var privateKey = localStorage.getItem('_priv'); // TODO look at sessionStorage for not reqiring decryption
		var wallet
		if(privateKey)  {
			wallet = new ethers.Wallet(privateKey);
		} else {
			wallet = ethers.Wallet.createRandom();
			privateKey = wallet.privateKey;
			localStorage.setItem('_priv', privateKey);
		}


		var supportedMethods = {
			"eth_accounts": function (payload, callback) {
				callback(null, [wallet.address]);
			},
			"eth_signTransaction": function (payload, callback, confirmed) {
				if(!confirmed) {
					callback(null, null, 'transaction');
				} else {
					wallet.sign(payload.params[0])
						.then(function(result){
							callback(null, result);
						})
						.catch(function(error){
							callback(error);
						});
				}
			}
		};

		var firstUrl = null;
		var source = window.parent;
		var currentUserConfirmation = null;
		
		function receiveMessage(event){
			console.log('IFRAME receiving', event.data);
			if(event.origin == window.origin) {
				if(event.data.type == 'confirmation') {
					console.log('POPUP transaction', event.data);
					console.log('WAITING for', currentUserConfirmation);
					if(currentUserConfirmation && currentUserConfirmation.id == event.data.id) {
						var copy = currentUserConfirmation;
						currentUserConfirmation = null;
						if(event.data.result) {
							processMessage(copy, source, true);
						} else {
							source.postMessage({id:copy.id,result:null,error:{message:"refused by user",type:"refused"}},firstUrl);
						}
					} else {
						console.error('old confirmation popup ?');
					}
				}
			}
			if(event.source != source){
				return;
			}
			if(firstUrl){
				if(firstUrl != event.origin){
					return;
				}
			}else{
				firstUrl = event.origin;
			}
			
			var data = event.data;
			try{
				processMessage(data,event.source);
			}catch(e){
				event.source.postMessage({id:data.id,result:null,error:{message:"Could not process message data",type:"notValid"}},firstUrl);
				console.error("Error", "The application has sent invalid data", data);
			}
		}
	
		function processMessage(payload, sourceWindow, confirmed){
			console.log('IFRAME, processMessage', payload);
			if(supportedMethods[payload.method]){
				supportedMethods[payload.method](payload, function(error, result, confirmationType) {
					if(confirmationType) {
						console.log('IFRAME confirmationType', confirmationType);
						console.log('payload', payload);
						currentUserConfirmation = payload; // TODO queue system ?
						authorizationLink.href = "popup.html#type=" + confirmationType + "&id=" + payload.id;
					}
					sourceWindow.postMessage({id:payload.id, result:result, error:error, requireUserConfirmation:confirmationType != null}, firstUrl);
				}, 
				confirmed);
			}else{
				sourceWindow.postMessage({id:payload.id, result:null, error:{message:"method (" + payload.method + ") not supported in iframe", type:"notAllowed"}},firstUrl);
			}
		}
		
		window.addEventListener("message", receiveMessage);
		source.postMessage("ready","*"); //TODO do not use wildcard
		</script>
	</body>
</html>